# ETS 编译器迭代 4 需求说明书

## 1. 概述

基于对 `harmony-utils` 项目的编译产物分析，本迭代需要支持以下 ArkTS/ETS 语法特性，使编译器能够正确编译 HarmonyOS 应用。

---

## 2. 核心语法支持

### 2.1 对象字面量表达式

**问题描述**：
- 对象字面量在函数参数中被错误转换为字符串
- 对象字面量属性值丢失

**源代码示例**：
```typescript
// 场景 A: 函数参数中的对象字面量
convertKey({ data: keyData })
{algName: 'IvParamsSpec', iv: { data: iv }}

// 场景 B: 变量声明的对象字面量
const packingOpts: image.PackingOption = { format: 'image/jpeg', quality: quality }
```

**预期输出**：
```javascript
convertKey({data: keyData})
{algName: "IvParamsSpec", iv: {data: iv}}
const packingOpts = {format: "image/jpeg", quality: quality}
```

---

### 2.2 NewExpression 表达式

**问题描述**：
- `new Class()` 被输出为 JSON 对象 `{"kind":215,"kindName":"NewExpression",...}`
- 带属性访问的 NewExpression 如 `new util.TextEncoder()` 未正确处理
- 嵌套的 NewExpression 如 `new Promise((resolve) => {...})` 未正确处理

**源代码示例**：
```typescript
// 场景 A: 简单 NewExpression
new Uint8Array(16)
new ArrayBuffer(stat.size)

// 场景 B: 带属性访问的 NewExpression
new util.TextEncoder()
new photoAccessHelper.PhotoSelectOptions()

// 场景 C: Promise 构造函数
new Promise<VideoInfo>((resolve) => {
  avPlayer.on('stateChange', async (state) => {
    if (state === 'initialized') {
      resolve({ width: 1920, height: 1080 })
    }
  })
})

// 场景 D: 带两个参数的 NewExpression
new RegExp(pattern, 'i')
```

**预期输出**：
```javascript
new Uint8Array(16)
new ArrayBuffer(stat.size)
new util.TextEncoder()
new photoAccessHelper.PhotoSelectOptions()
new Promise((resolve) => {
  avPlayer.on("stateChange", async (state) => {
    if (state === "initialized") {
      resolve({width: 1920, height: 1080})
    }
  })
})
new RegExp(pattern, "i")
```

---

### 2.3 模板字符串

**问题描述**：
- 简单模板字符串可能正常工作
- 复杂模板字符串（包含三元表达式、函数调用等）被输出为 JSON

**源代码示例**：
```typescript
// 场景 A: 简单模板字符串
`获取视频时长成功: ${result}ms`

// 场景 B: 包含三元表达式的模板字符串
`${message}: ${typeof error === 'string' ? error : error.message}`

// 场景 C: 包含属性访问的模板字符串
`视频截图功能已调用，时间点: ${timeMs}ms`

// 场景 D: 包含格式化的模板字符串
`${hours > 0 ? `${hours}小时${minutes}分${seconds}秒` : `${minutes}分${seconds}秒`}`
```

**预期输出**：
```javascript
`获取视频时长成功: ${result}ms`
`${message}: ${typeof error === "string" ? error : error.message}`
`视频截图功能已调用，时间点: ${timeMs}ms`
hours > 0 ? `${hours}小时${minutes}分${seconds}秒` : `${minutes}分${seconds}秒`
```

---

### 2.4 箭头函数

**问题描述**：
- 箭头函数作为参数时可能被转换为字符串
- 箭头函数内部使用 await 需要正确处理

**源代码示例**：
```typescript
// 场景 A: 作为参数的箭头函数
avPlayer.on('stateChange', async (state) => {
  if (state === 'initialized') {
    await avPlayer.prepare()
  }
})

// 场景 B: Promise 回调
new Promise<string>((resolve) => {
  // ...
})

// 场景 C: 事件回调
.onChange((value) => {
  this.inputText = value
})
```

**预期输出**：
```javascript
avPlayer.on("stateChange", async (state) => {
  if (state === "initialized") {
    await avPlayer.prepare()
  }
})
new Promise((resolve) => {
  // ...
})
.onChange((value) => {
  this.inputText = value
})
```

---

### 2.5 动态导入

**问题描述**：
- `await import()` 被输出为 `await {"kind":102,"kindName":"ImportKeyword"}(...)`

**源代码示例**：
```typescript
const nfcModule = await import('@ohos.nfc')
```

**预期输出**：
```javascript
const nfcModule = await import("@ohos.nfc")
```

---

## 3. 装饰器支持

### 3.1 @Entry 装饰器

**问题描述**：
- 使用 @Entry 装饰器的 struct 需要导出
- 当前编译结果未导出

**源代码示例**：
```typescript
@Entry
@Component
export struct ImagePage {
  build() { ... }
}
```

**预期输出**：
```javascript
export class ImagePage extends View {
  // ...
}
```

---

### 3.2 @Builder 方法

**问题描述**：
- @Builder 方法被当作普通方法处理
- 缺少 @Builder 方法的特殊包装逻辑

**源代码示例**：
```typescript
@Component
export struct Index {
  @Builder
  TabBar(index: number, icon: string, label: string) {
    Column() {
      Text(icon)
      Text(label)
    }
  }

  build() {
    this.TabBar(0, 'icon', 'label')
  }
}
```

**预期输出**：
```javascript
class Index extends View {
  TabBar(index, icon, label) {
    // @Builder 方法的正确实现
  }

  initialRender() {
    this.TabBar(0, "icon", "label")
  }
}
```

---

## 4. 类型系统支持

### 4.1 interface 接口声明

**问题描述**：
- interface 声明被忽略，未生成任何代码
- 但 TypeScript 的 interface 保留到运行时，需要转换为注释或删除

**源代码示例**：
```typescript
export interface FileInfo {
  uri: string
  name: string
  size: number
  lastModified: number
  isDirectory: boolean
  mimeType?: string
}

export interface VideoInfo {
  width: number
  height: number
  duration: number
  durationFormatted: string
  mimeType: string
}
```

**预期输出**：
```javascript
// interface 不生成运行时代码，可以生成注释或完全忽略
export class FileManager {
  // ...
}
```

---

### 4.2 类型注解

**问题描述**：
- 变量声明的类型注解需要移除
- 函数参数的类型注解已正确处理为注释

**源代码示例**：
```typescript
const files: FileInfo[] = []
const packingOpts: image.PackingOption = { format: 'image/jpeg', quality: quality }
```

**预期输出**：
```javascript
const files = []
const packingOpts = {format: "image/jpeg", quality: quality}
```

---

### 4.3 类型断言

**问题描述**：
- `as` 类型断言语法需要移除

**源代码示例**：
```typescript
Logger.error('操作失败', error as BusinessError)
Logger.error('操作失败', error as Error)
```

**预期输出**：
```javascript
Logger.error("操作失败", error)
```

---

## 5. 字面量支持

### 5.1 八进制字面量

**问题描述**：
- 八进制字面量语法 `0o1` 需要转换为十进制

**源代码示例**：
```typescript
const file = fs.openSync(fileUri, 0o1)  // READ_ONLY
const mode = 0o2 | 0o1000  // WRITE_ONLY | APPEND
```

**预期输出**：
```javascript
const file = fs.openSync(fileUri, 1)
const mode = 2 | 4096
```

---

### 5.2 字符串字面量引号保留

**问题描述**：
- 某些情况下字符串字面量的引号被移除，导致被误认为正则表达式

**源代码示例**：
```typescript
@State currentPath: string = '/data/storage/el2/base/haps/entry/files'
```

**预期输出**：
```javascript
private currentPath__ = "/data/storage/el2/base/haps/entry/files"
```

---

## 6. 控制流支持

### 6.1 for-of 循环

**问题描述**：
- `for (const item of items)` 循环的当前实现可能有问题

**源代码示例**：
```typescript
for (const file of files) {
  if (file.isDirectory) {
    await FileManager.deleteDirectory(file.uri, true)
  }
}
```

**预期输出**：
```javascript
for (const file of files) {
  if (file.isDirectory) {
    await FileManager.deleteDirectory(file.uri, true)
  }
}
```

---

### 6.2 for 循环

**问题描述**：
- 传统 for 循环的当前实现可能有问题

**源代码示例**：
```typescript
for (let i = 0; i < entries.length; i++) {
  const entry = entries[i]
  const fullPath = `${directoryUri}/${entry}`
}
```

**预期输出**：
```javascript
for (let i = 0; i < entries.length; i++) {
  const entry = entries[i]
  const fullPath = `${directoryUri}/${entry}`
}
```

---

## 7. 异步处理

### 7.1 async 方法

**问题描述**：
- async 方法已基本支持，需要验证所有场景

**源代码示例**：
```typescript
static async compressImage(sourceUri: string, quality: number): Promise<string> {
  const pixelMap = await imageSource.createPixelMap()
  return result
}

async selectImage(): Promise<void> {
  const result = await photoPicker.select(photoSelectOptions)
}
```

**预期输出**：
```javascript
static async compressImage(sourceUri, quality) {
  const pixelMap = await imageSource.createPixelMap()
  return result
}

async selectImage() {
  const result = await photoPicker.select(photoSelectOptions)
}
```

---

### 7.2 箭头函数中的 await

**问题描述**：
- 非异步箭头函数中使用 await，需要正确添加 async 关键字

**源代码示例**：
```typescript
Button('加密').onClick(() => {
  this.outputText = await CryptographyUtil.encryptAES(this.inputText, this.keyText)
})
```

**预期输出**：
```javascript
Button("加密").onClick(async () => {
  this.outputText = await CryptographyUtil.encryptAES(this.inputText, this.keyText)
})
```

---

## 8. UI 构建相关

### 8.1 属性链式调用主体绑定

**问题描述**：
- 组件方法链式调用缺少主体对象

**源代码示例**：
```typescript
@Builder
TabBar(index: number, icon: string, label: string) {
  Column() {
    Text(icon)
    Text(label)
  }
  .padding({ top: 8, bottom: 8 })
  .width('100%')
  .justifyContent(FlexAlign.Center)
}
```

**预期输出**：
```javascript
TabBar(index, icon, label) {
  Column.create()
  Text.create(icon)
  Text.pop()
  Text.create(label)
  Text.pop()
  Column.pop()

  this.padding({top: 8, bottom: 8}).width("100%").justifyContent(FlexAlign.Center)
}
```

---

### 8.2 状态属性初始化

**问题描述**：
- @State 属性初始化时产生循环引用

**源代码示例**：
```typescript
@State currentTab: number = 0
@State inputText: string = ''
```

**预期输出**：
```javascript
this.currentTab__ = this.createState('currentTab', 0)
this.inputText__ = this.createState('inputText', "")
```

---

## 9. 其他语法特性

### 9.1 可选链和空值合并

**源代码示例**：
```typescript
result?.photoUris?.length
value ?? defaultValue
```

**预期输出**：
```javascript
result?.photoUris?.length
value ?? defaultValue
```

---

### 9.2 属性访问表达式

**问题描述**：
- 某些复杂属性访问可能有问题

**源代码示例**：
```typescript
stat.size
fileUri.substring(fileUri.lastIndexOf('/') + 1)
videoMimeTypes.includes(mimeType)
```

---

## 10. 优先级分类

### P0 - 阻塞性问题（必须修复）

1. **对象字面量表达式** - 大量代码使用此语法
2. **NewExpression 表达式** - 构造函数调用广泛使用
3. **复杂模板字符串** - 日志输出等场景

### P1 - 重要功能（强烈建议）

4. **箭头函数完整支持** - 回调函数场景
5. **@Entry 装饰器** - 页面入口必须
6. **@Builder 方法** - 自定义构建函数
7. **八进制字面量** - 文件系统操作
8. **async 箭头函数** - 异步回调场景

### P2 - 增强功能（建议支持）

9. **动态导入** - 按需加载
10. **interface 声明** - 类型定义
11. **类型断言** - 类型转换
12. **属性链式调用绑定** - UI 代码

---

## 11. 验收标准

### 11.1 功能验收

- [ ] 所有 `harmony-utils` 项目文件编译通过
- [ ] 生成的 JS 文件通过 `node -c` 语法检查
- [ ] 生成的 JS 文件通过 `es2abc` 字节码编译
- [ ] 编译产物在 HarmonyOS 设备/模拟器上正常运行

### 11.2 测试用例

需要添加以下测试用例：
- 对象字面量各场景测试
- NewExpression 各场景测试
- 模板字符串复杂场景测试
- 箭头函数嵌套场景测试
- @Entry/@Builder 装饰器测试
- async/await 组合场景测试

---

## 12. 交付物

1. 完成的代码实现
2. 单元测试用例
3. 集成测试验证报告
4. 技术设计文档（可选）

---

## 附录 A：问题代码位置索引

| 语法特性 | 问题文件 | 行号示例 |
|---------|---------|---------|
| 对象字面量 | CryptographyUtil.js | 13, 16, 34, 37 |
| NewExpression | CryptographyUtil.js | 15, 18, 36, 54 |
| 模板字符串 | Logger.js | 11 |
| 箭头函数 | VideoProcessor.js | 12, 27, 41 |
| 动态导入 | NfcManager.js | 11, 24 |
| Promise | VideoProcessor.js | 12, 27, 41 |
| 八进制字面量 | FileManager.js | - |

---

## 附录 B：参考文件

- `src/test/resources/fixtures/harmony-utils/src/` - 源代码
- `src/test/resources/fixtures/harmony-utils/dist/` - 编译产物
- 本说明书基于上述文件的对比分析
