import { FileManager, FileInfo } from '../services/FileManager';
import { Logger } from '../utils/Logger';

@Entry
@Component
export struct FileSystemPage {
  @State currentPath: string = '/data/storage/el2/base/haps/entry/files';
  @State files: FileInfo[] = [];
  @State selectedFile: FileInfo | null = null;
  @State selectedTargetFile: string = '';
  @State searchText: string = '';
  @State fileContent: string = '';
  @State isDirectoryCreation: boolean = false;

  @Builder
  TabBar(index: number, icon: string, label: string) {
    Column() {
      Text(icon)
        .fontSize(24)
      Text(label)
        .fontSize(12)
        .margin({ top: 4 })
    }
    .padding({ top: 8, bottom: 8 })
    .width('100%')
    .justifyContent(FlexAlign.Center)
  }

  build() {
    Tabs({ barPosition: BarPosition.Start }) {
      TabContent() {
        Scroll() {
          Column({ space: 16 }) {
            Text('æ–‡ä»¶æµè§ˆå™¨')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)

            Divider()

            Row({ space: 16 }) {
              Button('åˆ·æ–°')
                .onClick(() => {
                  this.listFiles();
                })

              Button('æ–°å»ºæ–‡ä»¶å¤¹')
                .onClick(() => {
                  this.createDirectory();
                })
            }

            Divider()

            Row({ space: 16 }) {
              TextInput({ placeholder: 'æœç´¢å…³é”®è¯...' })
                .width('60%')
                .onChange((value) => {
                  this.searchText = value;
                })

              Button('æœç´¢')
                .onClick(() => {
                  this.searchFiles();
                })
            }

            Divider()

            Row({ space: 16 }) {
              Button('é€‰æ‹©æºæ–‡ä»¶')
                .onClick(() => {
                  this.selectSourceFile();
                })

              Button('é€‰æ‹©ç›®æ ‡æ–‡ä»¶')
                .onClick(() => {
                  this.selectTargetFile();
                })
            }

            Divider()

            Text('å½“å‰è·¯å¾„:')
              .fontSize(12)
              .fontColor('#666666')
              .margin({ left: 16 })

            Text(`${this.currentPath}`)
              .fontSize(14)
              .fontColor('#666666')

            Divider()

            Row({ space: 16 }) {
              Button('æ¸…ç©ºè·¯å¾„')
                .onClick(() => {
                  this.currentPath = '/data/storage/el2/base/haps/entry/files';
                })

              Button('æ ¹ç›®å½•')
                .onClick(() => {
                  this.currentPath = '/';
                })
            }

            Divider()

            Text('æ³¨æ„ï¼šé»˜è®¤è·¯å¾„ä¸ºï¼š`/data/storage/el2/base/haps/entry/files`')
              .fontSize(12)
              .fontColor('#666666')
              .margin({ left: 16 })
          }
          .width('100%')
          .padding(16)
        }
      }
      .tabBar(this.TabBar(0, 'ğŸ“', 'æµè§ˆ'))

      TabContent() {
        Scroll() {
          Column({ space: 16 }) {
            Text('æ–‡ä»¶æ“ä½œ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)

            Divider()

            Row({ space: 16 }) {
              Button('é€‰æ‹©æºæ–‡ä»¶')
                .onClick(() => {
                  this.selectSourceFile();
                })

              Button('é€‰æ‹©ç›®æ ‡æ–‡ä»¶')
                .onClick(() => {
                  this.selectTargetFile();
                })
            }

            Divider()

            Button('æ–‡ä»¶æ“ä½œ')
              .onClick(() => {
                this.showFileOptions();
              })

            Divider()

            Row({ space: 16 }) {
              Button('åˆ·æ–°')
                .onClick(() => {
                  this.listFiles();
                })
            }

            Divider()

            Text('æ–‡ä»¶æœç´¢')
              .fontSize(14)
              .fontColor('#666666')

            TextInput({ placeholder: 'æœç´¢å…³é”®è¯...' })
              .width('60%')
              .onChange((value) => {
                this.searchText = value;
              })

            Button('æœç´¢')
              .onClick(() => {
                this.searchFiles();
              })
          }
          .width('100%')
          .padding(16)
        }
      }
      .tabBar(this.TabBar(1, 'ğŸ“', 'æ“ä½œ'))

      TabContent() {
        Scroll() {
          Column({ space: 16 }) {
            Text('æ–‡ä»¶ä¿¡æ¯')
              .fontSize(20)
              .fontColor('#6666')

            Divider()

            if (this.selectedFile) {
              Text('æ–‡ä»¶å:')
                .fontSize(12)
                .fontColor('#6666')
                .margin({ left: 16 })

              Text(`${this.selectedFile.name}`)
                .fontSize(14)
                .fontColor('#6666')
                .margin({ left: 16 })

              Divider()

              Text('æ–‡ä»¶å¤§å°:')
                .fontSize(12)
                .fontColor('#6666')
                .margin({ left: 16 })

              Text(`${this.selectedFile.size} bytes`)
                .fontSize(14)
                .fontColor('#6666')
                .margin({ left: 16 })

              Divider()

              Text('æ–‡ä»¶ç±»å‹:')
                .fontSize(12)
                .fontColor('#6666')
                .margin({ left: 16 })

              Text(`${this.selectedFile.isDirectory ? 'ç›®å½•' : 'æ–‡ä»¶'}`)
                .fontSize(14)
                .fontColor('#6666')
                .margin({ left: 16 })

              Divider()

              Button('åˆ é™¤æ–‡ä»¶')
                .onClick(async () => {
                  if (this.selectedFile) {
                    const success = await FileManager.deleteFile(this.selectedFile.uri);
                    if (success) {
                      Logger.success('åˆ é™¤æ–‡ä»¶æˆåŠŸ');
                      this.selectedFile = null;
                      this.files = this.files.filter(f => f.uri !== this.selectedFile?.uri);
                    }
                  }
                })
            } else {
              Text('æœªé€‰æ‹©æ–‡ä»¶')
                .fontSize(14)
                .fontColor('#999999')
            }

            Divider()

            Text('æ–‡ä»¶å†…å®¹:')
              .fontSize(14)
              .fontColor('#6666')
              .margin({ left: 16 })

            Text(this.fileContent)
              .width('100%')
              .maxLines(10)
              .fontColor('#6666')
              .padding(12)
              .borderRadius(8)
              .backgroundColor('#F5F5F5')
          }
          .width('100%')
          .padding(16)
        }
      }
      .tabBar(this.TabBar(2, 'â„¹ï¸', 'ä¿¡æ¯'))
    }
    .barWidth(100)
    .animationDuration(300)
  }

  // Methods
  listFiles(): void {
    FileManager.listFiles(this.currentPath).then((files) => {
      this.files = files;
      Logger.success(`åˆ—å‡ºæ–‡ä»¶æˆåŠŸï¼Œå…± ${files.length} ä¸ªæ–‡ä»¶`);
    }).catch((error: Error) => {
      Logger.error('åˆ—å‡ºæ–‡ä»¶å¤±è´¥', error);
    });
  }

  createDirectory(): void {
    FileManager.createDirectory(this.currentPath + '/new_folder').then(() => {
      Logger.success('åˆ›å»ºç›®å½•æˆåŠŸ');
      this.listFiles();
    }).catch((error: Error) => {
      Logger.error('åˆ›å»ºç›®å½•å¤±è´¥', error);
    });
  }

  selectSourceFile(): void {
    Logger.info('é€‰æ‹©æºæ–‡ä»¶åŠŸèƒ½å¾…å®ç°');
  }

  selectTargetFile(): void {
    Logger.info('é€‰æ‹©ç›®æ ‡æ–‡ä»¶åŠŸèƒ½å¾…å®ç°');
  }

  showFileOptions(): void {
    Logger.info('æ–‡ä»¶æ“ä½œåŠŸèƒ½å¾…å®ç°');
  }

  searchFiles(): void {
    Logger.info('æœç´¢æ–‡ä»¶åŠŸèƒ½å¾…å®ç°');
  }

  onBackPressed(): void {
    Logger.info('è¿”å›åŠŸèƒ½å¾…å®ç°');
  }
}
